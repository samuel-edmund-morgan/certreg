# План покриття тестами CertReg

Документ деталізує фазу «Максимальне тестове покриття» з `ROADMAP.md`. Він містить поточний стан, цільову матрицю покриття, а також кроки для інструментування та блокування як PHP, так і Playwright тестів.

## 1. Поточний стан

| Область | Існуючі тести | Пробіли |
| --- | --- | --- |
| PHP backend (API + helpers) | `tests/run_tests.php`, `tests/lookup_count_test.php`, ручні виклики `self_check.php` в CI | Перевіряються лише `api/register.php`, `api/status.php`, лічильник lookup та базова схема. Немає сценаріїв для решти API, helper-логіки, авторизації, rate-limit, scripts. |
| Playwright E2E | ~35 сценаріїв (`tests/ui/*.spec.js`) покривають видачу (single/bulk), верифікацію, безпеку, PDF перевірки, org-switch | Немає детальних тестів для налаштувань організацій/шаблонів CRUD, операторів, брендування, журналу подій, акаунту адміністратора. Немає перевірок адаптивності та локальних edge-case UI. |
| GitHub Actions | `ci.yml` запускає PHP скрипти + Playwright, аплоадить звіти при помилці | Немає звітів покриття, немає матриці браузерів, немає сповіщень про деградацію покриття. |

## 2. Цільова матриця покриття

### 2.1 PHP (інтеграційні/юнiт)

| Модуль | Основні функції/гілки | Поточні тести | Плановані тести |
| --- | --- | --- | --- |
| `auth.php` | сесійна авторизація, role guard (`require_admin`, `require_login`) | відсутні | Написати симульовані запити з різними ролями/станами сесії, перевірити redirect/403. |
| `db.php`, `helpers.php`, `common_pagination.php` | конект до БД, хелпери пагінації, утиліти | відсутні | Створити юнiт/інтеграційні тести на пагінацію, перевірити формування SQL `LIMIT/OFFSET`, обробку edge cases. |
| `rate_limit.php` | `check_rate_limit`, `log_rate_limit_event` | відсутні | Імітувати IP/endpoint з різними лімітами, перевірити блокування й логування. |
| `api/register.php`, `revoke.php`, `unrevoke.php`, `status.php`, `bulk_action.php`, `delete_token.php` | CRUD над токенами | лише `register`+`status`+lookup | Додати тести на revoke/unrevoke/delete, bulk-операції (серія POST із JSON). |
| `api/org_*.php`, `operator_*.php` | CRUD організацій та операторів | відсутні | Сценарії створення/оновлення/видалення/перемикання статусу, негативні кейси (дублікат коду, повʼязані оператори/токени). |
| `api/template_*.php` | створення/оновлення/вимкнення шаблонів, валідація файлів | відсутні | Використати фейкові файли (мок через `tmpfile`), перевірити обмеження розміру/EXT, зміни статусів. |
| `api/branding_save.php`, `account_change_password.php`, `events.php` | налаштування брендування, пароль, журнал | відсутні | Тести на валідацію HEX, оновлення паролю з невірним поточним, фільтри журналу. |
| CLI `scripts/`, `self_check.php`, `scripts/security/` | інсталяції, перевірки прав | `self_check.php` запускається, інше — ні | Запустити ключові CLI з тестовими параметрами, мокати файлову систему де потрібно. |

### 2.2 JavaScript (юнiт/інтеграція в браузері)

| Модуль | Відповідальність | Поточні тести | План |
| --- | --- | --- | --- |
| `assets/js/issue*.js`, `verify.js` | бізнес-логіка видачі/перевірки | Playwright е2е | Додати browser-driven модульні тести (Playwright component-style) для edge-case (невірні поля, перевищення довжини, offline-режим). |
| `assets/js/settings_*.js` | CRUD UI налаштувань | мінімально (org_switch) | Покрити CRUD організацій, операторів, шаблонів, брендування (успіх + помилки, перезавантаження таблиць). |
| `assets/js/admin.js`, `tokens_page.js` | таблиці, фільтри | відсутні | Створити сценарії сортування, пошуку, пагінації, експорту CSV. |
| `assets/js/issue_bulk.js`, `issue_bulk_performance` | продуктивність і batch процеси | є perf/стрес тест | Додати контрольні функціональні перевірки для різних розмірів CSV, помилки парсингу. |

### 2.3 CSS/Поведінка UI
- Додати візуальні тести (Playwright screenshot diff) для ключових сторінок у desktop/mobile breakpoints.
- Перевірити стан фокусів/ARIA (accessibility smoke tests).

## 3. Інструментарій покриття

1. **PHP:** Увімкнути `Xdebug` або `pcov` у локальному режимі та CI. Налаштувати генерацію `coverage.php` + конвертація в `lcov` для Codecov/HTML.
2. **Playwright:** Використати `npx playwright test --reporter html,line --trace on-first-retry --config playwright.config.js`. Задіяти `v8Coverage` (`use: { coverageName }`) для вимірювання JS покриття.
3. **Збір артефактів:** Додати завантаження `coverage/` та `playwright-report/` в GitHub Actions. Пороги: PHP ≥ 80%, Playwright ≥ 70% для критичних сторінок (початково можна нижче й піднімати).

## 4. Фазування впровадження

1. **Фаза A — Бекенд критично важливі API**
   - Реалізувати інфраструктуру тестів (загальний bootstrap, фабрики даних, скидання БД).
   - Покрити `register/status`, `revoke/unrevoke/delete`, `org_*`, `operator_*`.

2. **Фаза B — Налаштування та шаблони**
   - Тести `template_*`, `branding_save`, `account_change_password`, CLI `self_check`/`scripts/security`.
   - Playwright сценарії CRUD брендування/шаблонів, перевірка збереження кольорів, upload.

3. **Фаза C — Перевірки UI/UX**
   - Playwright viewport/mobile, screenshot diff.
   - Accessibility smoke (axe-core інтеграція).

4. **Фаза D — Перформанс та негативні сценарії**
   - Рефактор перформанс тестів для repeatability, додати assertion порогів.
   - Негативні сценарії (rate limit, auth bypass, CSRF) на backend та UI.

## 5. Операційні задачі

- **Reset середовища для тестів:** створити скрипт `tests/reset_db.php` або використовувати транзакції/fixtures.
- **Seed даних:** стандартизувати фікстури (адмін, організації, шаблони) у `tests/fixtures/`.
- **Документація:** зафіксувати гайд з запуску тестів локально + додати розділ у майбутній інсталяційний мануал.
- **Підтримка CI:** паралелізувати Playwright по spec-файлах, закешувати `node_modules` та `vendor`.

## 6. Метрики успіху

- Повне покриття для всіх API endpoint-ів (мінімум по одному позитивному та одному негативному тесту).
- Playwright сценарії покривають усі адміністративні UI-флоу.
- Щонайменше 80% рядкового покриття для PHP критичного ядра (`api/*.php`, `helpers.php`, `rate_limit.php`).
- CI падає при падінні покриття або відсутності Playwright артефактів.

## 7. Наступні кроки

1. Підготувати загальний bootstrap-файл для PHP тестів (із повторним використанням моків/фабрик).
2. Створити перевірки для `api/org_create.php`, `api/org_delete.php`, `api/org_set_active.php` як перше розширення.
3. Додати Playwright сценарій CRUD організацій (розширити на брендування та шаблони).
4. Налаштувати локальне збирання покриття з `pcov` і зафіксувати результат у документації.
